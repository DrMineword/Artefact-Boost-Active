<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authorization Page</title>
    <style>
        body {
            background-image: url('https://raw.githubusercontent.com/DrMineword/1045060846654603305_bot_images/refs/heads/master/src/img/game/portraits/portrait_CerberusStation.png');
            background-size: cover;
            background-position: center;
            font-family: Arial, sans-serif;
            color: white;
            text-align: center;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 1s ease-out;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        .status {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        #authStatus {
            margin-top: 15px;
            font-size: 16px;
            font-weight: normal;
            color: yellow;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div>
        <div class="spinner"></div>
        <div class="status">Authorization in progress, please wait</div>
        <div id="authStatus">Fetching your data...</div>
    </div>

    <script>
        async function fetchPublicIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error("Error fetching public IP:", error);
                return null;
            }
        }

        async function fetchGeoData(ip) {
            const url = `https://x8ki-letl-twmt.n7.xano.io/api:bkcRu4oi/ip-data?ip=${ip}`;
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    console.error("Failed to fetch geolocation data:", response.status);
                    return null;
                }
            } catch (error) {
                console.error("Error fetching geolocation data:", error);
                return null;
            }
        }

        function updateLocalStorage(authValid, reason) {
            const now = Date.now();
            const authData = {
                auth_valid: authValid,
                auth_invalid_reason: reason,
                expire_at: now + 30 * 24 * 60 * 60 * 1000, // 30 days from now
            };
            localStorage.setItem('auth', JSON.stringify(authData));
        }

        async function processAuthorization() {
            try {
                const ip = await fetchPublicIP();
                if (!ip) {
                    document.getElementById('authStatus').textContent = 'Error fetching IP. Retrying...';
                    return;
                }

                const geoData = await fetchGeoData(ip);
                if (!geoData) {
                    document.getElementById('authStatus').textContent = 'Failed to fetch geolocation data.';
                    return;
                }

                const configResponse = await fetch("https://raw.githubusercontent.com/DrMineword/Artefact-Boost-Active/refs/heads/main/geo_location_ban/algoritm.json");
                const config = await configResponse.json();

                const vpnIndicators = [];

                // Timezone and connection checks
                const ipTimeZone = geoData?.data?.response?.result?.time_zone?.name;
                const browserTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (ipTimeZone && ipTimeZone !== browserTimeZone) {
                    vpnIndicators.push("Timezone mismatch");
                }

                if (geoData?.data?.response?.result?.connection_type === "vpn") {
                    vpnIndicators.push("VPN connection type detected");
                }

                if (geoData?.data?.response?.result?.isp?.toLowerCase().includes("vpn")) {
                    vpnIndicators.push("ISP suggests VPN usage");
                }

                // New addition: IP reputation checks if available
                if (geoData?.data?.response?.result?.threat?.is_vpn) {
                    vpnIndicators.push("IP flagged as VPN");
                }

                const vpnChance = vpnIndicators.length / 4; // Normalize probability
                const redirectUrl = config.redirect_url?.vpn || "https://example.com";
                const gobackUrl = new URLSearchParams(window.location.search).get('goback') || "https://example.com";

                if (vpnChance >= 0.25) {
                    if (!config.allow_vpn) {
                        updateLocalStorage(false, "VPN detected");
                        document.getElementById('authStatus').textContent = 'VPN usage detected. Access denied.';
                        setTimeout(() => {
                            window.location.href = `${redirectUrl}?goback=${encodeURIComponent(gobackUrl)}&reason=${encodeURIComponent("VPN detected")}`;
                        }, 2000);
                        return;
                    }
                }

                updateLocalStorage(true, null);
                document.getElementById('authStatus').textContent = 'Authorization successful.';
                setTimeout(() => {
                    window.location.href = gobackUrl;
                }, 1000);
            } catch (error) {
                console.error("Error during authorization process:", error);
                document.getElementById('authStatus').textContent = 'An unexpected error occurred.';
            }
        }

        // Overwrite auth field on every visit
        function overwriteAuthField() {
            const now = Date.now();
            const authData = {
                auth_valid: false,
                auth_invalid_reason: null,
                expire_at: now + 30 * 24 * 60 * 60 * 1000, // Default 30 days expiry
            };
            localStorage.setItem('auth', JSON.stringify(authData));
        }

        overwriteAuthField();
        processAuthorization();
    </script>
</body>
</html>
