KGZ1bmN0aW9uICgpIHsKICAgIGNvbnNvbGUubG9nKCJDYW52YXMgTWFuYWdlciBpbml0aWFsaXplZC4uLiIpOwoKICAgIC8vIENoZWNrIGlmIHRoZSBkb2N1bWVudCBvYmplY3QgaXMgYXZhaWxhYmxlICh3aGljaCBpbmRpY2F0ZXMgYSBicm93c2VyIGVudmlyb25tZW50KQogICAgaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCkgewogICAgICAgIC8vIENyZWF0ZSBhbmQgc3R5bGUgdGhlIGNhbnZhcwogICAgICAgIHZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgICBjYW52YXMuaWQgPSAiY2FudmFzIjsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNhbnZhcyk7CgogICAgICAgIGNhbnZhcy5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CiAgICAgICAgY2FudmFzLnN0eWxlLnRvcCA9ICIwIjsKICAgICAgICBjYW52YXMuc3R5bGUubGVmdCA9ICIwIjsKICAgICAgICBjYW52YXMuc3R5bGUuekluZGV4ID0gIjEwIjsKICAgICAgICBjYW52YXMuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJub25lIjsKICAgICAgICBjYW52YXMuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgICAgY2FudmFzLnN0eWxlLmhlaWdodCA9ICIxMDAlIjsKCiAgICAgICAgLy8gQ3JlYXRlIGFuZCBzdHlsZSB0aGUgbm90aWZpY2F0aW9uIGJhbm5lcgogICAgICAgIHZhciBub3RpZmljYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBub3RpZmljYXRpb24uaWQgPSAibm90aWZpY2F0aW9uLWJhbm5lciI7CiAgICAgICAgbm90aWZpY2F0aW9uLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKICAgICAgICBub3RpZmljYXRpb24uc3R5bGUudG9wID0gIjAiOwogICAgICAgIG5vdGlmaWNhdGlvbi5zdHlsZS5sZWZ0ID0gIjAiOwogICAgICAgIG5vdGlmaWNhdGlvbi5zdHlsZS53aWR0aCA9ICIxMDAlIjsKICAgICAgICBub3RpZmljYXRpb24uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gInJnYmEoMCwgMCwgMCwgMC44KSI7CiAgICAgICAgbm90aWZpY2F0aW9uLnN0eWxlLmNvbG9yID0gIndoaXRlIjsKICAgICAgICBub3RpZmljYXRpb24uc3R5bGUudGV4dEFsaWduID0gImNlbnRlciI7CiAgICAgICAgbm90aWZpY2F0aW9uLnN0eWxlLnBhZGRpbmcgPSAiMTBweCI7CiAgICAgICAgbm90aWZpY2F0aW9uLnN0eWxlLmZvbnRTaXplID0gIjE4cHgiOwogICAgICAgIG5vdGlmaWNhdGlvbi5zdHlsZS56SW5kZXggPSAiMjAiOyAvLyBIaWdoZXIgdGhhbiBjYW52YXMKICAgICAgICBub3RpZmljYXRpb24uc3R5bGUuZGlzcGxheSA9ICJub25lIjsgLy8gSW5pdGlhbGx5IGhpZGRlbgogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobm90aWZpY2F0aW9uKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRG9jdW1lbnQgb2JqZWN0IG5vdCBmb3VuZC4gVGhpcyBzY3JpcHQgcmVxdWlyZXMgYSBicm93c2VyIGVudmlyb25tZW50LiIpOwogICAgICAgIHJldHVybjsgLy8gRXhpdCBpZiBub3QgaW4gYSBicm93c2VyCiAgICB9CgogICAgLy8gRnVuY3Rpb24gdG8gZHluYW1pY2FsbHkgbG9hZCBhbmQgZXhlY3V0ZSBhIHNjcmlwdAogICAgZnVuY3Rpb24gbG9hZFNjcmlwdCh1cmwsIGRlc2NyaXB0aW9uID0gInNjcmlwdCIpIHsKICAgICAgICBjb25zb2xlLmxvZyhgQXR0ZW1wdGluZyB0byBsb2FkICR7ZGVzY3JpcHRpb259IGZyb20gJHt1cmx9YCk7CiAgICAgICAgcmV0dXJuIGZldGNoKHVybCkKICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gbG9hZCAke2Rlc2NyaXB0aW9ufS4gSFRUUCBzdGF0dXM6ICR7cmVzcG9uc2Uuc3RhdHVzfWApOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnRleHQoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRoZW4oc2NyaXB0Q29udGVudCA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtkZXNjcmlwdGlvbn0gbG9hZGVkIHN1Y2Nlc3NmdWxseS5gKTsKICAgICAgICAgICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICAgICAgICAgIHNjcmlwdC50ZXh0ID0gc2NyaXB0Q29udGVudDsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke2Rlc2NyaXB0aW9ufSBleGVjdXRlZCBzdWNjZXNzZnVsbHkuYCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBsb2FkaW5nICR7ZGVzY3JpcHRpb259OmAsIGVycm9yKTsKICAgICAgICAgICAgfSk7CiAgICB9CgogICAgLy8gSlNPTi1saWtlIGNvbmZpZ3VyYXRpb24gZm9yIGNhbnZhcyBhbmltYXRpb25zIChzaW1wbGlmaWVkIHdpdGggbmV3IGRhdGUgZm9ybWF0KQogICAgdmFyIGNhbnZhc1NjaGVkdWxlcyA9IFsKICAgICAgICB7CiAgICAibmFtZSI6ICJDaHJpc3RtYXMgRXZlbnQiLAogICAgInVybCI6ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRHJNaW5ld29yZC9BcnRlZmFjdC1Cb29zdC1BY3RpdmUvcmVmcy9oZWFkcy9tYWluL3Nub3d5LmNhbnZhIiwKICAgICJkYXRlcyI6IHsKICAgICAgICAiZGF0ZXMiOiBbCiAgICAgICAgICAgICIxMi0wMVQwMDowMCIsICIxMi0wMlQwMDowMCIsICIxMi0wM1QwMDowMCIsICIxMi0wNFQwMDowMCIsICIxMi0wNVQwMDowMCIsIAogICAgICAgICAgICAiMTItMDZUMDA6MDAiLCAiMTItMDdUMDA6MDAiLCAiMTItMDhUMDA6MDAiLCAiMTItMDlUMDA6MDAiLCAiMTItMTBUMDA6MDAiLCAKICAgICAgICAgICAgIjEyLTExVDAwOjAwIiwgIjEyLTEyVDAwOjAwIiwgIjEyLTEzVDAwOjAwIiwgIjEyLTE0VDAwOjAwIiwgIjEyLTE1VDAwOjAwIiwgCiAgICAgICAgICAgICIxMi0xNlQwMDowMCIsICIxMi0xN1QwMDowMCIsICIxMi0xOFQwMDowMCIsICIxMi0xOVQwMDowMCIsICIxMi0yMFQwMDowMCIsIAogICAgICAgICAgICAiMTItMjFUMDA6MDAiLCAiMTItMjJUMDA6MDAiLCAiMTItMjNUMDA6MDAiLCAiMTItMjRUMDA6MDAiLCAiMTItMjVUMDA6MDAiLCAKICAgICAgICAgICAgIjEyLTI2VDAwOjAwIiwgIjEyLTI3VDAwOjAwIiwgIjEyLTI4VDAwOjAwIiwgIjEyLTI5VDAwOjAwIiwgIjEyLTMwVDAwOjAwIiwgCiAgICAgICAgICAgICAiMDEtMDJUMDA6MDAiLCAiMDEtMDNUMDA6MDAiLCAiMDEtMDRUMDA6MDAiLCAKICAgICAgICAgICAgIjAxLTA1VDAwOjAwIiwgIjAxLTA2VDAwOjAwIiwgIjAxLTA3VDAwOjAwIiwgIjAxLTA4VDAwOjAwIiwgIjAxLTA5VDAwOjAwIiwgCiAgICAgICAgICAgICIwMS0xMFQwMDowMCIsICIwMS0xMVQwMDowMCIsICIwMS0xMlQwMDowMCIsICIwMS0xM1QwMDowMCIsICIwMS0xNFQwMDowMCIsIAogICAgICAgICAgICAiMDEtMTVUMDA6MDAiLCAiMDEtMTZUMDA6MDAiLCAiMDEtMTdUMDA6MDAiLCAiMDEtMThUMDA6MDAiLCAiMDEtMTlUMDA6MDAiLCAKICAgICAgICAgICAgIjAxLTIwVDAwOjAwIiwgIjAxLTIxVDAwOjAwIiwgIjAxLTIyVDAwOjAwIiwgIjAxLTIzVDAwOjAwIiwgIjAxLTI0VDAwOjAwIiwgCiAgICAgICAgICAgICIwMS0yNVQwMDowMCIsICIwMS0yNlQwMDowMCIsICIwMS0yN1QwMDowMCIsICIwMS0yOFQwMDowMCIsICIwMS0yOVQwMDowMCIsIAogICAgICAgICAgICAiMDEtMzBUMDA6MDAiLCAiMDEtMzFUMDA6MDAiCiAgICAgICAgXSwKICAgICAgICAiZHVyYXRpb24iOiAiZnVsbC1kYXkiCiAgICB9LAogICAgIm1lc3NhZ2UiOiAiTWVycnkgQ2hyaXN0bWFzISBFbmpveSB0CmhlIGZlc3RpdmUgc2Vhc29uISIKfSwKICAgICAgICB7CiAgICAgICAgICAgIG5hbWU6ICJOZXcgWWVhcidzIEV2ZSIsCiAgICAgICAgICAgIHVybDogImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9Eck1pbmV3b3JkL0FydGVmYWN0LUJvb3N0LUFjdGl2ZS9yZWZzL2hlYWRzL21haW4vTmV3X1llYXJzX0V2ZS5leGUuY2FudmEiLAogICAgICAgICAgICBkYXRlczogewogICAgICAgICAgICAgICAgZGF0ZXM6IFsiMTItMzFUMjA6MDAiLCAiMDEtMDFUMDA6MDAiXSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAiZnVsbC1kYXkiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1lc3NhZ2U6ICJIYXBweSBOZXcgWWVhciEhIgogICAgICAgIH0KICAgIF07CgogICAgLy8gRnVuY3Rpb24gdG8gY2hlY2sgaWYgdGhlIGN1cnJlbnQgZGF0ZSBpcyB3aXRoaW4gdGhlIHNjaGVkdWxlZCBkYXRlcwogICAgZnVuY3Rpb24gaXNEYXRlSW5SYW5nZShkYXRlcykgewogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgIHZhciBjdXJyZW50RGF0ZVN0cmluZyA9IG5vdy50b0lTT1N0cmluZygpLnNsaWNlKDUsIDE2KTsgIC8vICJNTS1ERFRISDpNTSIgZm9ybWF0CgogICAgICAgIGNvbnNvbGUubG9nKCJDdXJyZW50IHRpbWU6Iiwgbm93LnRvSVNPU3RyaW5nKCkpOwoKICAgICAgICAvLyBDaGVjayBpZiBjdXJyZW50IGRhdGUgaXMgaW4gdGhlIGxpc3Qgb2YgZGF0ZXMKICAgICAgICBpZiAoZGF0ZXMuZGF0ZXMuaW5jbHVkZXMoY3VycmVudERhdGVTdHJpbmcpKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDdXJyZW50IHRpbWUgaXMgd2l0aGluIHRoZSByYW5nZTogJHtjdXJyZW50RGF0ZVN0cmluZ31gKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBjb25zb2xlLmxvZygiQ3VycmVudCB0aW1lIGlzIG5vdCB3aXRoaW4gYW55IHNwZWNpZmllZCBkYXRlLiIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBGdW5jdGlvbiB0byBmaW5kIHRoZSBjdXJyZW50IGNhbnZhcyBzY2hlZHVsZQogICAgZnVuY3Rpb24gZ2V0Q3VycmVudFNjaGVkdWxlKCkgewogICAgICAgIGZvciAodmFyIHNjaGVkdWxlIG9mIGNhbnZhc1NjaGVkdWxlcykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgRXZhbHVhdGluZyBzY2hlZHVsZTogJHtzY2hlZHVsZS5uYW1lfWApOwogICAgICAgICAgICBpZiAoaXNEYXRlSW5SYW5nZShzY2hlZHVsZS5kYXRlcykpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBNYXRjaGluZyBzY2hlZHVsZSBmb3VuZDogJHtzY2hlZHVsZS5uYW1lfWApOwogICAgICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb25zb2xlLmxvZygiTm8gbWF0Y2hpbmcgc2NoZWR1bGUgZm91bmQuIik7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gRnVuY3Rpb24gdG8gbG9hZCBhbmQgYXBwbHkgdGhlIGFwcHJvcHJpYXRlIGNhbnZhcyBjb250ZW50CiAgICBmdW5jdGlvbiBsb2FkQ2FudmFzQ29udGVudCgpIHsKICAgICAgICBjb25zb2xlLmxvZygiTG9hZGluZyBjYW52YXMgY29udGVudC4uLiIpOwoKICAgICAgICB2YXIgc2NoZWR1bGUgPSBnZXRDdXJyZW50U2NoZWR1bGUoKTsKICAgICAgICBpZiAoc2NoZWR1bGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYExvYWRpbmcgY2FudmFzIGZvcjogJHtzY2hlZHVsZS5uYW1lfWApOwogICAgICAgICAgICBsb2FkU2NyaXB0KHNjaGVkdWxlLnVybCwgImNhbnZhcyBjb250ZW50Iik7CgogICAgICAgICAgICAvLyBEaXNwbGF5IG5vdGlmaWNhdGlvbiBtZXNzYWdlCiAgICAgICAgICAgIGlmIChzY2hlZHVsZS5tZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBub3RpZmljYXRpb24uaW5uZXJUZXh0ID0gc2NoZWR1bGUubWVzc2FnZTsKICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsgLy8gU2hvdyB0aGUgYmFubmVyCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgRGlzcGxheWVkIG5vdGlmaWNhdGlvbjogJHtzY2hlZHVsZS5tZXNzYWdlfWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIk5vIGNhbnZhcyBjb250ZW50IHRvIGxvYWQgYXQgdGhpcyB0aW1lLiIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBJbml0aWFsaXplIGV2ZXJ5dGhpbmcKICAgIGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgY29uc29sZS5sb2coIkluaXRpYWxpemluZyBDYW52YXMgTWFuYWdlci4uLiIpOwogICAgICAgIGxvYWRDYW52YXNDb250ZW50KCk7CiAgICB9CgogICAgaW5pdGlhbGl6ZSgpOwp9KSgpOw
