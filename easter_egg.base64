// Create a canvas that sits on top of the page
const canvas = document.createElement('canvas');
canvas.style.position = 'fixed';
canvas.style.top = '0';
canvas.style.left = '0';
canvas.style.width = '100%';
canvas.style.height = '100%';
canvas.style.pointerEvents = 'none'; // Ensure the canvas doesn't block interactions
canvas.style.zIndex = '9999'; // Always on top
document.body.appendChild(canvas);

const ctx = canvas.getContext('2d');
let width = window.innerWidth;
let height = window.innerHeight;
canvas.width = width;
canvas.height = height;

let snowflakes = [];
let snowSettings = {
  snowflakeCount: 100,
  minSize: 1,
  maxSize: 3,
  speed: 1,
  lightThreshold: 190, // Brightness threshold for outlines
};

// Fetch settings from external JSON
fetch('https://raw.githubusercontent.com/DrMineword/Artefact-Boost-Active/refs/heads/main/snowy.json')
  .then((response) => response.json())
  .then((data) => {
    snowSettings = { ...snowSettings, ...data };
    createSnowflakes();
  })
  .catch((error) => {
    console.error('Failed to load snow settings:', error);
    createSnowflakes(); // Use default settings if fetch fails
  });

// Utility function to check brightness of the background under a snowflake
function isLightBackground(x, y) {
  const imageData = ctx.getImageData(x, y, 1, 1).data;
  const brightness = (imageData[0] + imageData[1] + imageData[2]) / 3; // Average RGB
  return brightness > snowSettings.lightThreshold;
}

// Snowflake class
class Snowflake {
  constructor() {
    this.reset();
  }

  reset() {
    this.x = Math.random() * width;
    this.y = Math.random() * height;
    this.radius = Math.random() * (snowSettings.maxSize - snowSettings.minSize) + snowSettings.minSize;
    this.speedX = Math.random() * 2 - 1;
    this.speedY = Math.random() * snowSettings.speed + 0.5;
  }

  update() {
    this.x += this.speedX;
    this.y += this.speedY;

    if (this.x > width || this.x < 0 || this.y > height) {
      this.reset(); // Reset snowflake position when it goes out of bounds
      this.y = -this.radius; // Start from the top
    }
  }

  draw() {
    const outline = isLightBackground(this.x, this.y) ? 'black' : 'transparent';

    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fillStyle = 'white';
    ctx.fill();
    if (outline !== 'transparent') {
      ctx.strokeStyle = outline;
      ctx.lineWidth = 0.5;
      ctx.stroke();
    }
    ctx.closePath();
  }
}

// Initialize snowflakes
function createSnowflakes() {
  snowflakes = [];
  for (let i = 0; i < snowSettings.snowflakeCount; i++) {
    snowflakes.push(new Snowflake());
  }
}

// Resize canvas on window resize
window.addEventListener('resize', () => {
  width = window.innerWidth;
  height = window.innerHeight;
  canvas.width = width;
  canvas.height = height;
});

// Animation loop
function animate() {
  ctx.clearRect(0, 0, width, height);
  snowflakes.forEach((snowflake) => {
    snowflake.update();
    snowflake.draw();
  });
  requestAnimationFrame(animate);
}

// Start animation
animate();