Y29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY2FudmFzKTsKCmNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwppZiAoIWN0eCkgewogIGNvbnNvbGUuZXJyb3IoIkVycm9yOiBVbmFibGUgdG8gZ2V0IDJEIHJlbmRlcmluZyBjb250ZXh0LiIpOwogIHRocm93IG5ldyBFcnJvcigiQ2FudmFzIHJlbmRlcmluZyBjb250ZXh0IGlzIG5vdCBzdXBwb3J0ZWQuIik7Cn0KCmxldCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwpsZXQgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwpjYW52YXMud2lkdGggPSB3aWR0aDsKY2FudmFzLmhlaWdodCA9IGhlaWdodDsKCi8vIENhbnZhcyBzdHlsZSBzZXR0aW5ncwpjYW52YXMuc3R5bGUuekluZGV4ID0gJzI1JzsKY2FudmFzLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7CmNhbnZhcy5zdHlsZS5wb3NpdGlvbiA9ICdmaXhlZCc7Cgpjb25zdCBzbm93Zmxha2VzID0gW107CmNvbnN0IHNub3dmbGFrZUNvdW50ID0gMTUwOyAvLyBOdW1iZXIgb2Ygc25vd2ZsYWtlcwpjb25zdCBsaWdodFRocmVzaG9sZCA9IDE5MDsgLy8gQnJpZ2h0bmVzcyB0aHJlc2hvbGQgZm9yIG91dGxpbmVzCmxldCBhbmltYXRpb25JZDsKCi8vIFV0aWxpdHkgZnVuY3Rpb24gdG8gY2hlY2sgYnJpZ2h0bmVzcyBvZiB0aGUgYmFja2dyb3VuZCB1bmRlciBhIHNub3dmbGFrZQpmdW5jdGlvbiBpc0xpZ2h0QmFja2dyb3VuZCh4LCB5KSB7CiAgdHJ5IHsKICAgIC8vIEVuc3VyZSBjb29yZGluYXRlcyBhcmUgd2l0aGluIGNhbnZhcyBib3VuZHMKICAgIGlmICh4IDwgMCB8fCB4ID49IHdpZHRoIHx8IHkgPCAwIHx8IHkgPj0gaGVpZ2h0KSByZXR1cm4gZmFsc2U7CgogICAgY29uc3QgaW1hZ2VEYXRhID0gY3R4LmdldEltYWdlRGF0YSh4LCB5LCAxLCAxKS5kYXRhOwogICAgY29uc3QgYnJpZ2h0bmVzcyA9IChpbWFnZURhdGFbMF0gKyBpbWFnZURhdGFbMV0gKyBpbWFnZURhdGFbMl0pIC8gMzsgLy8gQXZlcmFnZSBSR0IKICAgIHJldHVybiBicmlnaHRuZXNzID4gbGlnaHRUaHJlc2hvbGQ7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvciBpbiBpc0xpZ2h0QmFja2dyb3VuZDoiLCBlcnIpOwogICAgcmV0dXJuIGZhbHNlOyAvLyBEZWZhdWx0IHRvIGRhcmsgYmFja2dyb3VuZCBvbiBlcnJvcgogIH0KfQoKLy8gU25vd2ZsYWtlIGNsYXNzCmNsYXNzIFNub3dmbGFrZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnggPSBNYXRoLnJhbmRvbSgpICogd2lkdGg7CiAgICB0aGlzLnkgPSBNYXRoLnJhbmRvbSgpICogaGVpZ2h0OwogICAgdGhpcy5yYWRpdXMgPSBNYXRoLnJhbmRvbSgpICogMyArIDE7CiAgICB0aGlzLnNwZWVkWCA9IE1hdGgucmFuZG9tKCkgKiAyIC0gMTsKICAgIHRoaXMuc3BlZWRZID0gTWF0aC5yYW5kb20oKSAqIDIgKyAxOwogIH0KCiAgdXBkYXRlKCkgewogICAgdGhpcy54ICs9IHRoaXMuc3BlZWRYOwogICAgdGhpcy55ICs9IHRoaXMuc3BlZWRZOwoKICAgIGlmICh0aGlzLnggPiB3aWR0aCkgdGhpcy54ID0gMDsKICAgIGlmICh0aGlzLnggPCAwKSB0aGlzLnggPSB3aWR0aDsKICAgIGlmICh0aGlzLnkgPiBoZWlnaHQpIHRoaXMueSA9IDA7CiAgfQoKICBkcmF3KCkgewogICAgdHJ5IHsKICAgICAgY29uc3Qgb3V0bGluZSA9IGlzTGlnaHRCYWNrZ3JvdW5kKHRoaXMueCwgdGhpcy55KSA_ICdibGFjaycgOiAndHJhbnNwYXJlbnQnOwoKICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICBjdHguYXJjKHRoaXMueCwgdGhpcy55LCB0aGlzLnJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICBjdHguZmlsbFN0eWxlID0gJ3doaXRlJzsKICAgICAgY3R4LmZpbGwoKTsKICAgICAgaWYgKG91dGxpbmUgIT09ICd0cmFuc3BhcmVudCcpIHsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBvdXRsaW5lOwogICAgICAgIGN0eC5saW5lV2lkdGggPSAwLjU7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICB9CiAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBjb25zb2xlLmVycm9yKCJFcnJvciBpbiBkcmF3IG1ldGhvZDoiLCBlcnIpOwogICAgfQogIH0KfQoKLy8gSW5pdGlhbGl6ZSBzbm93Zmxha2VzCmZ1bmN0aW9uIGNyZWF0ZVNub3dmbGFrZXMoKSB7CiAgc25vd2ZsYWtlcy5sZW5ndGggPSAwOyAvLyBDbGVhciBleGlzdGluZyBzbm93Zmxha2VzCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzbm93Zmxha2VDb3VudDsgaSsrKSB7CiAgICBzbm93Zmxha2VzLnB1c2gobmV3IFNub3dmbGFrZSgpKTsKICB9Cn0KCi8vIFJlc2l6ZSBjYW52YXMgb24gd2luZG93IHJlc2l6ZQp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgKCkgPT4gewogIHRyeSB7CiAgICBjYW5jZWxBbmltYXRpb25GcmFtZShhbmltYXRpb25JZCk7IC8vIFN0b3Agb25nb2luZyBhbmltYXRpb24KICAgIHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICBjYW52YXMud2lkdGggPSB3aWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICBjcmVhdGVTbm93Zmxha2VzKCk7IC8vIFJlY3JlYXRlIHNub3dmbGFrZXMgZm9yIG5ldyBkaW1lbnNpb25zCiAgICBhbmltYXRlKCk7IC8vIFJlc3RhcnQgYW5pbWF0aW9uCiAgfSBjYXRjaCAoZXJyKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvciBkdXJpbmcgcmVzaXplIGV2ZW50OiIsIGVycik7CiAgfQp9KTsKCi8vIEFuaW1hdGlvbiBsb29wCmZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgdHJ5IHsKICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7CiAgICBzbm93Zmxha2VzLmZvckVhY2goKHNub3dmbGFrZSkgPT4gewogICAgICBzbm93Zmxha2UudXBkYXRlKCk7CiAgICAgIHNub3dmbGFrZS5kcmF3KCk7CiAgICB9KTsKICAgIGFuaW1hdGlvbklkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogIH0gY2F0Y2ggKGVycikgewogICAgY29uc29sZS5lcnJvcigiRXJyb3IgaW4gYW5pbWF0aW9uIGxvb3A6IiwgZXJyKTsKICB9Cn0KCi8vIFN0YXJ0IHNub3cgZWZmZWN0CnRyeSB7CiAgY3JlYXRlU25vd2ZsYWtlcygpOwogIGFuaW1hdGUoKTsKfSBjYXRjaCAoZXJyKSB7CiAgY29uc29sZS5lcnJvcigiRXJyb3IgaW5pdGlhbGl6aW5nIHNub3cgZWZmZWN0OiIsIGVycik7Cn0
