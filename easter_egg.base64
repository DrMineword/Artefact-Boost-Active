KGZ1bmN0aW9uICgpIHsKICAgIGNvbnNvbGUubG9nKCJDYW52YXMgTWFuYWdlciBpbml0aWFsaXplZC4uLiIpOwoKICAgIC8vIENyZWF0ZSBhbmQgc3R5bGUgdGhlIGNhbnZhcwogICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgY2FudmFzLmlkID0gImNhbnZhcyI7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNhbnZhcyk7CgogICAgY2FudmFzLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKICAgIGNhbnZhcy5zdHlsZS50b3AgPSAiMCI7CiAgICBjYW52YXMuc3R5bGUubGVmdCA9ICIwIjsKICAgIGNhbnZhcy5zdHlsZS56SW5kZXggPSAiMTAiOwogICAgY2FudmFzLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAibm9uZSI7CiAgICBjYW52YXMuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwoKICAgIC8vIENyZWF0ZSBhbmQgc3R5bGUgdGhlIG5vdGlmaWNhdGlvbiBiYW5uZXIKICAgIHZhciBub3RpZmljYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIG5vdGlmaWNhdGlvbi5pZCA9ICJub3RpZmljYXRpb24tYmFubmVyIjsKICAgIG5vdGlmaWNhdGlvbi5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CiAgICBub3RpZmljYXRpb24uc3R5bGUudG9wID0gIjAiOwogICAgbm90aWZpY2F0aW9uLnN0eWxlLmxlZnQgPSAiMCI7CiAgICBub3RpZmljYXRpb24uc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICBub3RpZmljYXRpb24uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gInJnYmEoMCwgMCwgMCwgMC44KSI7CiAgICBub3RpZmljYXRpb24uc3R5bGUuY29sb3IgPSAid2hpdGUiOwogICAgbm90aWZpY2F0aW9uLnN0eWxlLnRleHRBbGlnbiA9ICJjZW50ZXIiOwogICAgbm90aWZpY2F0aW9uLnN0eWxlLnBhZGRpbmcgPSAiMTBweCI7CiAgICBub3RpZmljYXRpb24uc3R5bGUuZm9udFNpemUgPSAiMThweCI7CiAgICBub3RpZmljYXRpb24uc3R5bGUuekluZGV4ID0gIjIwIjsgLy8gSGlnaGVyIHRoYW4gY2FudmFzCiAgICBub3RpZmljYXRpb24uc3R5bGUuZGlzcGxheSA9ICJub25lIjsgLy8gSW5pdGlhbGx5IGhpZGRlbgogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChub3RpZmljYXRpb24pOwoKICAgIC8vIEZ1bmN0aW9uIHRvIGR5bmFtaWNhbGx5IGxvYWQgYW5kIGV4ZWN1dGUgYSBzY3JpcHQKICAgIGZ1bmN0aW9uIGxvYWRTY3JpcHQodXJsLCBkZXNjcmlwdGlvbiA9ICJzY3JpcHQiKSB7CiAgICAgICAgY29uc29sZS5sb2coYEF0dGVtcHRpbmcgdG8gbG9hZCAke2Rlc2NyaXB0aW9ufSBmcm9tICR7dXJsfWApOwogICAgICAgIHJldHVybiBmZXRjaCh1cmwpCiAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0-IHsKICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGxvYWQgJHtkZXNjcmlwdGlvbn0uIEhUVFAgc3RhdHVzOiAke3Jlc3BvbnNlLnN0YXR1c31gKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS50ZXh0KCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC50aGVuKHNjcmlwdENvbnRlbnQgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7ZGVzY3JpcHRpb259IGxvYWRlZCBzdWNjZXNzZnVsbHkuYCk7CiAgICAgICAgICAgICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgICAgICAgICBzY3JpcHQudGV4dCA9IHNjcmlwdENvbnRlbnQ7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtkZXNjcmlwdGlvbn0gZXhlY3V0ZWQgc3VjY2Vzc2Z1bGx5LmApOwogICAgICAgICAgICB9KQogICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgbG9hZGluZyAke2Rlc2NyaXB0aW9ufTpgLCBlcnJvcik7CiAgICAgICAgICAgIH0pOwogICAgfQoKICAgIC8vIEpTT04tbGlrZSBjb25maWd1cmF0aW9uIGZvciBjYW52YXMgYW5pbWF0aW9ucwogICAgdmFyIGNhbnZhc1NjaGVkdWxlcyA9IFsKICAgICAgICB7CiAgICAgICAgICAgIG5hbWU6ICJDaHJpc3RtYXMgRXZlbnQiLAogICAgICAgICAgICB1cmw6ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRHJNaW5ld29yZC9BcnRlZmFjdC1Cb29zdC1BY3RpdmUvcmVmcy9oZWFkcy9tYWluL3Nub3d5LmNhbnZhIiwKICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKERhdGUuVVRDKG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSwgMTEsIDI0LCAwLCAwKSksIC8vIERlYyAyNCwgMDA6MDAgVVRDCiAgICAgICAgICAgIGVuZDogbmV3IERhdGUoRGF0ZS5VVEMobmV3IERhdGUoKS5nZXRGdWxsWWVhcigpLCAxMSwgMjYsIDIzLCA1OSkpLCAvLyBEZWMgMjYsIDIzOjU5IFVUQwogICAgICAgICAgICBtZXNzYWdlOiAiTWVycnkgQ2hyaXN0bWFzISBFbmpveSB0aGUgaG9saWRheSBzZWFzb24hIgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBuYW1lOiAiTmV3IFllYXIncyBFdmUiLAogICAgICAgICAgICB1cmw6ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRHJNaW5ld29yZC9BcnRlZmFjdC1Cb29zdC1BY3RpdmUvcmVmcy9oZWFkcy9tYWluL05ld19ZZWFyc19FdmUuZXhlLmNhbnZhIiwKICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKERhdGUuVVRDKG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSwgMTEsIDMxLCAyMCwgMCkpLCAvLyBEZWMgMzEsIDIwOjAwIFVUQwogICAgICAgICAgICBlbmQ6IG5ldyBEYXRlKERhdGUuVVRDKG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSArIDEsIDAsIDEsIDMsIDApKSwgLy8gSmFuIDEsIDAzOjAwIFVUQwogICAgICAgICAgICBtZXNzYWdlOiAiSGFwcHkgTmV3IFllYXIhISIKICAgICAgICB9CiAgICBdOwoKICAgIC8vIEZ1bmN0aW9uIHRvIGZpbmQgdGhlIGN1cnJlbnQgY2FudmFzIHNjaGVkdWxlCiAgICBmdW5jdGlvbiBnZXRDdXJyZW50U2NoZWR1bGUoKSB7CiAgICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7CiAgICAgICAgY29uc29sZS5sb2coIkNoZWNraW5nIGN1cnJlbnQgdGltZToiLCBub3cudG9JU09TdHJpbmcoKSk7CgogICAgICAgIGZvciAodmFyIHNjaGVkdWxlIG9mIGNhbnZhc1NjaGVkdWxlcykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgRXZhbHVhdGluZyBzY2hlZHVsZTogJHtzY2hlZHVsZS5uYW1lfWApOwogICAgICAgICAgICBpZiAobm93ID49IHNjaGVkdWxlLnN0YXJ0ICYmIG5vdyA8PSBzY2hlZHVsZS5lbmQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDdXJyZW50IHRpbWUgbWF0Y2hlcyBzY2hlZHVsZTogJHtzY2hlZHVsZS5uYW1lfWApOwogICAgICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb25zb2xlLmxvZygiTm8gbWF0Y2hpbmcgc2NoZWR1bGUgZm91bmQgZm9yIHRoZSBjdXJyZW50IHRpbWUuIik7CiAgICAgICAgcmV0dXJuIG51bGw7IC8vIE5vIGFuaW1hdGlvbiBzaG91bGQgYmUgYWN0aXZlCiAgICB9CgogICAgLy8gRnVuY3Rpb24gdG8gbG9hZCBhbmQgYXBwbHkgdGhlIGFwcHJvcHJpYXRlIGNhbnZhcyBjb250ZW50CiAgICBmdW5jdGlvbiBsb2FkQ2FudmFzQ29udGVudCgpIHsKICAgICAgICBjb25zb2xlLmxvZygiTG9hZGluZyBjYW52YXMgY29udGVudC4uLiIpOwoKICAgICAgICB2YXIgc2NoZWR1bGUgPSBnZXRDdXJyZW50U2NoZWR1bGUoKTsKICAgICAgICBpZiAoc2NoZWR1bGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYExvYWRpbmcgY2FudmFzIGZvcjogJHtzY2hlZHVsZS5uYW1lfWApOwogICAgICAgICAgICBsb2FkU2NyaXB0KHNjaGVkdWxlLnVybCwgImNhbnZhcyBjb250ZW50Iik7CgogICAgICAgICAgICAvLyBEaXNwbGF5IG5vdGlmaWNhdGlvbiBtZXNzYWdlCiAgICAgICAgICAgIGlmIChzY2hlZHVsZS5tZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBub3RpZmljYXRpb24uaW5uZXJUZXh0ID0gc2NoZWR1bGUubWVzc2FnZTsKICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsgLy8gU2hvdyB0aGUgYmFubmVyCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgRGlzcGxheWVkIG5vdGlmaWNhdGlvbjogJHtzY2hlZHVsZS5tZXNzYWdlfWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIk5vIGNhbnZhcyBjb250ZW50IHRvIGxvYWQgYXQgdGhpcyB0aW1lLiIpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBMb2FkIHRoZSBhZGRpdGlvbmFsIGNvbW1hbmQgZXhlY3V0aW9uIHNjcmlwdAogICAgZnVuY3Rpb24gbG9hZENvbW1hbmRFeGVjdXRvcigpIHsKICAgICAgICBjb25zb2xlLmxvZygiTG9hZGluZyBjb21tYW5kIGV4ZWN1dG9yIHNjcmlwdC4uLiIpOwogICAgICAgIGxvYWRTY3JpcHQoCiAgICAgICAgICAgICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRHJNaW5ld29yZC9BcnRlZmFjdC1Cb29zdC1BY3RpdmUvcmVmcy9oZWFkcy9tYWluL2NtZC5leGVjdXRlIiwKICAgICAgICAgICAgImNvbW1hbmQgZXhlY3V0b3IiCiAgICAgICAgKTsKICAgIH0KCiAgICAvLyBJbml0aWFsaXplIGV2ZXJ5dGhpbmcKICAgIGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgY29uc29sZS5sb2coIkluaXRpYWxpemluZyBDYW52YXMgTWFuYWdlci4uLiIpOwogICAgICAgIGxvYWRDYW52YXNDb250ZW50KCk7CiAgICAgICAgbG9hZENvbW1hbmRFeGVjdXRvcigpOwogICAgfQoKICAgIGluaXRpYWxpemUoKTsKfSkoKTs
